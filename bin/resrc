#!/bin/bash
FILES_BASE=$HOME/.resrc
BACKUP_DIR=$FILES_BASE/.bkp
CURRENT_USER_FILE=$FILES_BASE/.current_user
cmd=$1

function debug () {
  echo $@
}

# ensure the base directory is available
function set_up () {
  mkdir -p $FILES_BASE
}

# add a user from github.com
# $1  : username
function add_user () {
  # validate arguments
  if [[ -z "$1" ]]; then
    echo "Invalid arguments"
    usage
    return 1
  fi

  set_up
  username=$1
  user_files=$FILES_BASE/$username
  if [ -d $user_files ]
  then
    echo "User already exists."
    return 1
  fi
  no_dot=$(curl -s -o /dev/null -w "%{http_code}" https://api.github.com/repos/$username/.files)
  [ "$no_dot" == "200" ] && git clone https://github.com/$username/.files.git $user_files

  dot=$(curl -s -o /dev/null -w "%{http_code}" https://api.github.com/repos/$username/.dotfiles)
  [ "$dot" == "200" ] && git clone https://github.com/$username/.dotfiles.git $user_files
}

# remove a user locally
# $1  : username
function rm_user () {
  # validate arguments
  if [[ -z "$1" ]]; then
    echo "Invalid arguments"
    usage
    return 1
  fi

  username=$1
  user_files=$FILES_BASE/$username
  if [ -L $user_files ]; then
    rm $user_files
  else
    mv $user_files $FILES_BASE/.bkp/$username
  fi

}

# list out locally available users
function list_users () {
  ls $FILES_BASE
}

# symlink in a user repo that is already on the loca filesystem.
# useful for working on your dot files locally and testing things out before
# pushing to github.
# $1  : username
# $2  : /path/to/local/repo
function link_user () {
  # validate arguments
  if [[ -z "$1" || -z "$2" || ! -d "$2" ]]; then
    echo "Invalid arguments"
    usage
    return 1
  fi

  set_up

  username=$1
  pushd $2
  dir=`pwd`
  popd
  user_files=$FILES_BASE/$username
  if [ -d $user_files ]
  then
    echo "User already exists."
    return 1
  fi
  ln -s $dir $user_files
}

function clean_home () {
  # cleanup old links
  HOME_FILES=$HOME/.[a-z]*
  for f in $HOME_FILES
  do
    if [ -L $f ]; then
      linked_file=$(readlink $f)
      debug $f  $linked_file  $FILES_BASE
      [[ $linked_file == $FILES_BASE* ]] && rm $f
    fi
  done
}

function unbecome_user () {
  clean_home

  mkdir -p $BACKUP_DIR

  PREV_FILES=$BACKUP_DIR/.[a-z]*
  for f in $PREV_FILES
  do
    filename=$(basename $f)
    homefile=$HOME/$filename
    backup_file=$BACKUP_DIR/$filename

    if [ -f $homefile -o -d $homefile ]; then
      echo "$homefile already exists. Moving it to $homefile.bkp"
      mv $homefile $homefile.bkp
    fi
    cp $backup_file $homefile
  done
}

# set local .files to point to the .files for the specified username. If the
# user is not available locally, they will be cloned from github.
# $1  : username
function become_user () {
  # validate arguments
  if [[ -z "$1" ]]; then
    echo "Invalid arguments"
    usage
    return 1
  fi

  username=$1

  # if that user isn't available locally, add them
  if [[ ! -d $FILES_BASE/$username ]]; then
    echo "user $username not available locally, adding..."
    resrc add $username
  fi

  mkdir -p $BACKUP_DIR

  # un-become the current user
  unbecome_user

  # link in all files
  FILES=$FILES_BASE/$username/.[a-z]*
  for f in $FILES
  do
    filename=$(basename $f)
    homefile=$HOME/$filename
    backup_file=$BACKUP_DIR/$filename
    [ -f $backup_file -o -d $backup_file ] && rm -r $backup_file
    [ -f $homefile -o -d $homefile ] && mv $homefile $backup_file
    [ "$filename" != ".git" ] && ln -s $f $homefile
  done
  echo $username > $CURRENT_USER_FILE
}

function become_user_soft () {
  # NOT USED RIGHT NOW. Changing $HOME messes with too many things (espcially ~)
  username=$1
  echo '' > $RESRC_HOME/.profile
  echo 'export RESRC_HOME=$HOME' >> $RESRC_HOME/.profile
  echo "export HOME=$FILES_BASE/$username" >> $RESRC_HOME/.profile
  echo 'source $HOME/.profile' >> $RESRC_HOME/.profile
  source $RESRC_HOME/.profile
}

function get_current_user () {
  cat $CURRENT_USER_FILE
}

# ssh in and become the current local user on the remote machine
function ssh () {
  debug $@
  RESRC_USER=`get_current_user`
  URL=https://raw.github.com/smurthas/resrc/master/bin/resrc
  INSTALL=/usr/local/bin/resrc
  if [[ $@ =~ ^(-i\ [~./a-zA-Z_0-9]+\ )?([a-zA-Z]+@)?[a-zA-Z0-9.-]+ ]]
  then
    debug "matched!"
    /usr/bin/ssh $@ "source /etc/profile && source \$HOME/.profile && \
      which resrc || \
      sudo sh -c 'curl $URL > $INSTALL 2>/dev/null &&  chmod +x $INSTALL' && \
      resrc become $RESRC_USER"; \
      /usr/bin/ssh $@
  else
    debug "no match, just using SSH"
    /usr/bin/ssh $@
  fi
}

# echo the the current user's directory
# $1  : username=`get_current_user`
function user_dir () {
  username=$1
  if [[ -z "$username" ]]; then
    username=`get_current_user`
  fi

  echo $FILES_BASE/$username
}

function usage() {
  echo ""
  echo "  Usage: resrc [command] [options]"
  echo ""
  echo "  Commands:"
  echo ""
  echo "    add <username>        : add a user from github."
  echo "    rm <username>         : remove a user locally."
  echo "    link <username> <dir> : link in a local set of dot files."
  echo "    list                  : list all local users."
  echo "    clean                 : clean all symlinks out of home dir."
  echo "    become <username>     : switch to a user. will install if not present."
  echo "    unbecome              : switch back to backed up .files."
  echo "    ssh <ssh_options>     : ssh into a remote server and become the local user remotely."
  echo "    dir [username]        : echo the direction of local user's .files (defaults to value of $CURRENT_USER_FILE)."
  echo ""
}

case "$cmd" in
  add)
    add_user $2
    ;;
  rm)
    rm_user $2
    ;;
  list)
    list_users
    ;;
  link)
    link_user $2 $3
    ;;
  become)
    become_user $2
    ;;
  unbecome)
    unbecome_user
    ;;
  clean)
    clean_home
    ;;
  ssh)
    shift
    ssh $@
    ;;
  dir)
    shift
    user_dir $@
    ;;
  *)
    echo "Invalid command."
    usage
    exit 1
  ;;
esac
